"use strict";function forEachCodePoint(e,t){let n=0;for(;n<e.length;){let a=e.codePointAt(n),r=a>=65536?2:1;t(n,r,a),n+=r}}function isCodePointIdeographic(e){return e>=13312&&e<=19903||e>=19968&&e<=40959||e>=63744&&e<=64255||e>=131072&&e<=173791||e>=173824&&e<=177983||e>=177984&&e<=178207||e>=178208&&e<=183983||e>=183984&&e<=191471||e>=194560&&e<=195103||e>=196608&&e<=201551||12293==e||12295==e||12539==e}function isCodePointProhibited(e){return e<=32||e>=65&&e<=90||e>=97&&e<=122||e>=65313&&e<=65338||e>=65345&&e<=65370||"　/\\／＼ĀĪŪĒŌāīūēō̄".includes(String.fromCodePoint(e))}const API_URI="https://translate.googleapis.com/translate_a/single?client=t&sl=ja&dt=rm&tk=";function transliterate(e,t){let n=ticket(e),a=new XMLHttpRequest;return a.open("POST",API_URI+n),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),a.onreadystatechange=()=>{if(a.readyState==XMLHttpRequest.DONE)if(200==a.status){let e=JSON.parse(a.responseText)[0];null!=e?t(e[0][3]):fail("Not Japanese",t)}else 0!=a.status&&fail(`Server returned status code ${a.status}`,t);else a.readyState==XMLHttpRequest.UNSENT&&fail("Request unsent",t)},a.send("q="+encodeURIComponent(e)),a}let notated=!1,req=null;function buttonClicked(e){let t=document.getElementById("text"),n=document.getElementById("result");notated?(notated=!1,null==req||req.abort(),e.innerHTML="Notate",n.innerHTML="",t.style.display="inline"):(notated=!0,e.innerHTML="Abort",req=notate(t.value,(a=>{null!=a?(t.style.display="none",e.innerHTML="Clear",a.forEach((e=>{n.innerHTML+=lineToHtml(e)}))):(notated=!1,e.innerHTML="Notate")})))}function fail(e,t){t(null),window.alert(`Failed to notate: ${e}`)}function lineToHtml(e){return`<p>${null!=e.kanaNotated?e.kanaNotated:`<span style="color: red">${e.origin}</span>`}<br/>${e.romaji}</p>`}const HIRAGANA_START=12353,HIRAGANA_END=12436,KATAKANA_START=12449,KATAKANA_END=12532,HIRA_KATA_OFFSET=96,ROMAJI=["~a","a","~i","i","~u","u","~e","e","~o","o","ka","ga","ki","gi","ku","gu","ke","ge","ko","go","sa","za","shi","ji","su","zu","se","ze","so","zo","ta","da","chi","dji","~tsu","tsu","dzu","te","de","to","do","na","ni","nu","ne","no","ha","ba","pa","hi","bi","pi","fu","bu","pu","he","be","pe","ho","bo","po","ma","mi","mu","me","mo","~ya","ya","~yu","yu","~yo","yo","ra","ri","ru","re","ro","~wa","wa","wi","we","wo","n","vu"],VA_LINE_START=12535,VA_LINE_END=12538,VA_LINE=["va","vi","ve","vo"],ROMAJI_TO_KANA=new Map;function notateKana(e,t,n,a){let r=a.length;if(0==r)return e;let o=t.match(n);if(null==o)return null;let i="",l=0;for(let t=0;t<r;t++){let n=a[t],r=o[t+1].trim();i+=e.substring(l,n),0!=r.length&&(r.indexOf("/")>=0&&(r='<span style="color: red">ERROR<span>'),i+=`(<b>${r}</b>)`),l=n}return i+=e.substring(l,e.length),i}function romajiToKana(e){const t=/n(?![yaiueoāīūēō])|[wrtypsdfghjkzcvbnm~]*[aiueoāīūēō]|\b \b| ?\u0304/g;let n,a="",r=0;for(;null!=(n=t.exec(e));){let o=t.lastIndex-n[0].length-r,i=e[r];1==o&&" "==i?a+=" ":0!=o&&(0==r||1!=o||"'"!=i&&"-"!=i)&&(a+="/"),r=t.lastIndex;let l=n[0],s=l.length;if(" "==l){a+=" ";continue}if("̄"==l[s-1]){a+="ー";continue}if(s>2){let e=l[0],t=l[1];(e==t||"t"==e&&"c"==t)&&(l=l.substring(1),s--,a+="っ")}let u=l[s-1],c="āīūēō".indexOf(u);c>=0?(l=l.substring(0,s-1)+"aiueo"[c],a+=romajiSyllableToKana(l),a+="あいうえう"[c]):a+=romajiSyllableToKana(l)}return r!=e.length&&(a+="/"),a}ROMAJI.forEach(((e,t)=>{ROMAJI_TO_KANA.set(e,String.fromCharCode(12353+t))})),VA_LINE.forEach(((e,t)=>{ROMAJI_TO_KANA.set(e,String.fromCharCode(12535+t))}));const YOUON_1=/^[kgnhbpmr]y[aueo]$/,YOUON_2=/^(?:sh|j|ch|dj)[aueo]$/,YOUON_3=/^f[aieo]$/;function romajiSyllableToKana(e){let t="",n=ROMAJI_TO_KANA.get(e);if(null!=n)t+=n;else if(YOUON_1.test(e)){t+=ROMAJI_TO_KANA.get(e[0]+"i");let n=e[2];t+="e"==n?"ぇ":ROMAJI_TO_KANA.get("~y"+n)}else if(YOUON_2.test(e)){t+=ROMAJI_TO_KANA.get(e.substring(0,e.length-1)+"i");let n=e[e.length-1];t+="e"==n?"ぇ":ROMAJI_TO_KANA.get("~y"+n)}else YOUON_3.test(e)?(t+="ふ",t+=ROMAJI_TO_KANA.get("~"+e[1])):"ti"==e?t+="てぃ":"di"==e?t+="でぃ":console.error("No such kana: "+e);return t}function jaToRegex(e,t){let n="^",a=e.length,r=0,o=-1;return forEachCodePoint(e,((a,i,l)=>{let s=String.fromCodePoint(l),u=isInVaLine(l),c=u||isKatakana(l),g=isHiragana(l);if(c||g||"ー"==s){if(o>=0&&(n+=groupForFlag(o),t.push(a)),c)switch(s){case"オ":n+="[おう]";break;case"ァ":case"ィ":case"ゥ":case"ェ":case"ォ":let e=l-96;n+=String.fromCharCode(91,e,e+1,93);break;default:n+=String.fromCharCode(u?l:l-96)}else if("ー"==s)if(isKatakana(r)){let e=ROMAJI[r-12449];n+="あいうえう"["aiueo".indexOf(e[e.length-1])]}else isInVaLine(r)?n+="あいえう"[r-12535]:n+="ー";else switch(s){case"お":n+="[おう]";break;case"は":n+="[はわ]";break;case"へ":n+="[へえ]";break;case"を":n+="[をお]";break;case"ぁ":case"ぃ":case"ぅ":case"ぇ":case"ぉ":n+=String.fromCharCode(91,l,l+1,93);break;default:n+=e.substring(a,a+i)}r=l,o=-1,n+=" ?"}else isCodePointIdeographic(l)?(o<0&&(o=0),"・"!=s&&o++):(o>=0&&(n+=groupForFlag(o),t.push(a)),-2!=o&&(n+="/ ?",o=-2))})),o>=0&&(n+=groupForFlag(o),t.push(a)),n+"$"}function groupForFlag(e){if(0==e)return"";let t=6*e;return`(.{${e},${t}}? |.{${e},${t}}?)`}function isHiragana(e){return e>=12353&&e<=12436}function isKatakana(e){return e>=12449&&e<=12532}function isInVaLine(e){return e>=12535&&e<=12538}function merge(e,t){let n="",a=0;for(let r=0;r<=e.length;r++)if(r==e.length||"\n"==e[r]){if(a==r){a=r+1;continue}let o=e.substring(a,r).trim();if(0==o.length){a=r+1;continue}t.push(o),n+=mergeLine(o),r!=e.length&&(n+="\\"),a=r+1}return n}function mergeLine(e){let t=null,n=!0;return forEachCodePoint(e,((a,r,o)=>{isCodePointProhibited(o)?(null==t&&(t=e.substring(0,a)),n=!1):null!=t&&(n||(t+="/"),t+=e.substring(a,a+r),n=!0)})),n||(t+="/"),null!=t?t:e}function notate(e,t){let n=[],a=merge(e,n);return 0==a.length?(fail("Empty text",t),null):a.length>5e3?(fail("Merged text length > 5000",t),null):transliterate(a,(e=>{if(null==e)return void t(null);let a=e.split("\\"),r=[];for(let e=0;e<n.length;e++){let o,i=n[e],l=trimAny(a[e]," -").toLowerCase(),s=romajiToKana(l),u=[],c=jaToRegex(i,u);try{o=notateKana(i,s,c,u)}catch(e){return void fail("Stack overflow due to massive line, consider splitting it",t)}r.push(new NotatedLine(i,l,o))}t(r)}))}function trimAny(e,t){let n=0,a=e.length;for(;n<a&&t.indexOf(e[n])>=0;)++n;for(;a>n&&t.indexOf(e[a-1])>=0;)--a;return n>0||a<e.length?e.substring(n,a):e}class NotatedLine{constructor(e,t,n){this.origin=e,this.romaji=t,this.kanaNotated=n}}var tkk=[440167,1966722350];function du(e,t){for(var n=0;n<t.length-2;n+=3){var a=t.charAt(n+2);a="a"<=a?a.charCodeAt(0)-87:Number(a),a="+"==t.charAt(n+1)?e>>>a:e<<a,e="+"==t.charAt(n)?e+a&4294967295:e^a}return e}function ticket(e){for(var t=tkk[0],n=[],a=0,r=0;r<e.length;r++){var o=e.charCodeAt(r);128>o?n[a++]=o:(2048>o?n[a++]=o>>6|192:(55296==(64512&o)&&r+1<e.length&&56320==(64512&e.charCodeAt(r+1))?(o=65536+((1023&o)<<10)+(1023&e.charCodeAt(++r)),n[a++]=o>>18|240,n[a++]=o>>12&63|128):n[a++]=o>>12|224,n[a++]=o>>6&63|128),n[a++]=63&o|128)}for(e=t,a=0;a<n.length;a++)e=du(e+=n[a],"+-a^+6");return e=du(e,"+-3^+b+-f"),0>(e^=tkk[1])&&(e=2147483648+(2147483647&e)),(e%=1e6).toString()+"."+(e^t)}