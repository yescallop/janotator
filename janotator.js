"use strict";var __awaiter=this&&this.__awaiter||function(t,e,n,o){return new(n||(n=Promise))((function(r,a){function i(t){try{u(o.next(t))}catch(t){a(t)}}function l(t){try{u(o.throw(t))}catch(t){a(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,l)}u((o=o.apply(t,e||[])).next())}))};function forEachCodePoint(t,e){let n=0;for(;n<t.length;){let o=t.codePointAt(n),r=o>=65536?2:1;e(n,r,o),n+=r}}function isCodePointIdeographic(t){return t>=13312&&t<=19903||t>=19968&&t<=40959||t>=63744&&t<=64255||t>=131072&&t<=173791||t>=173824&&t<=177983||t>=177984&&t<=178207||t>=178208&&t<=183983||t>=183984&&t<=191471||t>=194560&&t<=195103||t>=196608&&t<=201551||12293==t||12295==t||12539==t}function isCodePointProhibited(t){return t<=32||t>=65&&t<=90||t>=97&&t<=122||t>=65313&&t<=65338||t>=65345&&t<=65370||"　/\\／＼ĀĪŪĒŌāīūēō̄".includes(String.fromCodePoint(t))}const API_URI="https://translate.googleapis.com/translate_a/single?client=t&sl=ja&dt=rm&tk=";function transliterate(t,e){return __awaiter(this,void 0,void 0,(function*(){return fetch(API_URI+ticket(t),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"q="+encodeURIComponent(t),signal:e}).then((t=>{if(200!=t.status)throw`Server returned status code ${t.status}`;return t.json()})).then((t=>{let e=t[0];if(null!=e)return e[0][3];throw"Not Japanese"}))}))}let controller,notated=!1;function buttonClicked(t){let e=document.getElementById("text"),n=document.getElementById("result");notated?(notated=!1,controller.abort(),t.innerHTML="Notate",n.innerHTML="",e.style.display="inline"):(notated=!0,t.innerHTML="Abort",controller=new AbortController,notate(e.value,controller.signal).then((o=>{null!=o?(e.style.display="none",t.innerHTML="Clear",o.forEach((t=>{n.innerHTML+=lineToHtml(t)}))):(notated=!1,t.innerHTML="Notate")})).catch((e=>{e instanceof DOMException&&e.code==DOMException.ABORT_ERR||window.alert(`Failed to notate: ${e}`),notated=!1,t.innerHTML="Notate"})))}function lineToHtml(t){return`<p>${null!=t.kanaNotated?t.kanaNotated:`<span style="color: red">${t.origin}</span>`}<br/>${t.romaji}</p>`}const HIRAGANA_START=12353,HIRAGANA_END=12436,KATAKANA_START=12449,KATAKANA_END=12532,HIRA_KATA_OFFSET=96,ROMAJI=["~a","a","~i","i","~u","u","~e","e","~o","o","ka","ga","ki","gi","ku","gu","ke","ge","ko","go","sa","za","shi","ji","su","zu","se","ze","so","zo","ta","da","chi","dji","~tsu","tsu","dzu","te","de","to","do","na","ni","nu","ne","no","ha","ba","pa","hi","bi","pi","fu","bu","pu","he","be","pe","ho","bo","po","ma","mi","mu","me","mo","~ya","ya","~yu","yu","~yo","yo","ra","ri","ru","re","ro","~wa","wa","wi","we","wo","n","vu"],VA_LINE_START=12535,VA_LINE_END=12538,VA_LINE=["va","vi","ve","vo"],ROMAJI_TO_KANA=new Map;function notateKana(t,e,n,o){let r=o.length;if(0==r)return t;let a=e.match(n);if(null==a)return null;let i="",l=0;for(let e=0;e<r;e++){let n=o[e],r=a[e+1].trim();i+=t.substring(l,n),0!=r.length&&(r.indexOf("/")>=0&&(r='<span style="color: red">ERROR<span>'),i+=`(<b>${r}</b>)`),l=n}return i+=t.substring(l,t.length),i}function romajiToKana(t){const e=/n(?![yaiueoāīūēō])|[wrtypsdfghjkzcvbnm~]*[aiueoāīūēō]|\b \b| ?\u0304/g;let n,o="",r=0;for(;null!=(n=e.exec(t));){let a=e.lastIndex-n[0].length-r,i=t[r];1==a&&" "==i?o+=" ":0!=a&&(0==r||1!=a||"'"!=i&&"-"!=i)&&(o+="/"),r=e.lastIndex;let l=n[0],u=l.length;if(" "==l){o+=" ";continue}if("̄"==l[u-1]){o+="ー";continue}if(u>2){let t=l[0],e=l[1];(t==e||"t"==t&&"c"==e)&&(l=l.substring(1),u--,o+="っ")}let s=l[u-1],c="āīūēō".indexOf(s);c>=0?(l=l.substring(0,u-1)+"aiueo"[c],o+=romajiSyllableToKana(l),o+="あいうえう"[c]):o+=romajiSyllableToKana(l)}return r!=t.length&&(o+="/"),o}ROMAJI.forEach(((t,e)=>{ROMAJI_TO_KANA.set(t,String.fromCharCode(12353+e))})),VA_LINE.forEach(((t,e)=>{ROMAJI_TO_KANA.set(t,String.fromCharCode(12535+e))}));const YOUON_1=/^[kgnhbpmr]y[aueo]$/,YOUON_2=/^(?:sh|j|ch|dj)[aueo]$/,YOUON_3=/^f[aieo]$/;function romajiSyllableToKana(t){let e="",n=ROMAJI_TO_KANA.get(t);if(null!=n)e+=n;else if(YOUON_1.test(t)){e+=ROMAJI_TO_KANA.get(t[0]+"i");let n=t[2];e+="e"==n?"ぇ":ROMAJI_TO_KANA.get("~y"+n)}else if(YOUON_2.test(t)){e+=ROMAJI_TO_KANA.get(t.substring(0,t.length-1)+"i");let n=t[t.length-1];e+="e"==n?"ぇ":ROMAJI_TO_KANA.get("~y"+n)}else YOUON_3.test(t)?(e+="ふ",e+=ROMAJI_TO_KANA.get("~"+t[1])):"ti"==t?e+="てぃ":"di"==t?e+="でぃ":console.error("No such kana: "+t);return e}function jaToRegex(t,e){let n="^",o=t.length,r=0,a=-1;return forEachCodePoint(t,((o,i,l)=>{let u=String.fromCodePoint(l),s=isInVaLine(l),c=s||isKatakana(l),h=isHiragana(l);if(c||h||"ー"==u){if(a>0&&(n+=kanjiGroup(a),e.push(o)),c)switch(u){case"オ":n+="[おう]";break;case"ァ":case"ィ":case"ゥ":case"ェ":case"ォ":let t=l-96;n+=String.fromCharCode(91,t,t+1,93);break;default:n+=String.fromCharCode(s?l:l-96)}else if("ー"==u)if(isKatakana(r)){let t=ROMAJI[r-12449];n+="あいうえう"["aiueo".indexOf(t[t.length-1])]}else isInVaLine(r)?n+="あいえう"[r-12535]:n+="ー";else switch(u){case"お":n+="[おう]";break;case"は":n+="[はわ]";break;case"へ":n+="[へえ]";break;case"を":n+="[をお]";break;case"ぁ":case"ぃ":case"ぅ":case"ぇ":case"ぉ":n+=String.fromCharCode(91,l,l+1,93);break;default:n+=t.substring(o,o+i)}r=l,a=-1,n+=" ?"}else isCodePointIdeographic(l)?(a<0&&(a=0),"・"!=u&&a++):(a>0&&(n+=kanjiGroup(a),e.push(o)),-2!=a&&(n+="/ ?",a=-2))})),a>0&&(n+=kanjiGroup(a),e.push(o)),n+"$"}function kanjiGroup(t){let e=6*t;return`(.{${t},${e}}? |.{${t},${e}}?)`}function isHiragana(t){return t>=12353&&t<=12436}function isKatakana(t){return t>=12449&&t<=12532}function isInVaLine(t){return t>=12535&&t<=12538}function merge(t,e){let n="",o=0;for(let r=0;r<=t.length;r++)if(r==t.length||"\n"==t[r]){if(o==r){o=r+1;continue}let a=t.substring(o,r).trim();if(0==a.length){o=r+1;continue}e.push(a),n+=mergeLine(a),r!=t.length&&(n+="\\"),o=r+1}return n}function mergeLine(t){let e=null,n=!0;return forEachCodePoint(t,((o,r,a)=>{isCodePointProhibited(a)?(null==e&&(e=t.substring(0,o)),n=!1):null!=e&&(n||(e+="/"),e+=t.substring(o,o+r),n=!0)})),n||(e+="/"),null!=e?e:t}function notate(t,e){return __awaiter(this,void 0,void 0,(function*(){let n=[],o=merge(t,n);if(0==o.length)throw"Empty text";if(o.length>5e3)throw"Merged text length > 5000";return transliterate(o,e).then((t=>{let e=t.split("\\"),o=[];for(let t=0;t<n.length;t++){let r,a=n[t],i=trimAny(e[t]," -").toLowerCase(),l=romajiToKana(i),u=[],s=jaToRegex(a,u);try{r=notateKana(a,l,s,u)}catch(t){throw"Stack overflow due to massive line, consider splitting it"}o.push(new NotatedLine(a,i,r))}return o}))}))}function trimAny(t,e){let n=0,o=t.length;for(;n<o&&e.indexOf(t[n])>=0;)++n;for(;o>n&&e.indexOf(t[o-1])>=0;)--o;return n>0||o<t.length?t.substring(n,o):t}class NotatedLine{constructor(t,e,n){this.origin=t,this.romaji=e,this.kanaNotated=n}}var tkk=[440167,1966722350];function du(t,e){for(var n=0;n<e.length-2;n+=3){var o=e.charAt(n+2);o="a"<=o?o.charCodeAt(0)-87:Number(o),o="+"==e.charAt(n+1)?t>>>o:t<<o,t="+"==e.charAt(n)?t+o&4294967295:t^o}return t}function ticket(t){for(var e=tkk[0],n=[],o=0,r=0;r<t.length;r++){var a=t.charCodeAt(r);128>a?n[o++]=a:(2048>a?n[o++]=a>>6|192:(55296==(64512&a)&&r+1<t.length&&56320==(64512&t.charCodeAt(r+1))?(a=65536+((1023&a)<<10)+(1023&t.charCodeAt(++r)),n[o++]=a>>18|240,n[o++]=a>>12&63|128):n[o++]=a>>12|224,n[o++]=a>>6&63|128),n[o++]=63&a|128)}for(t=e,o=0;o<n.length;o++)t=du(t+=n[o],"+-a^+6");return t=du(t,"+-3^+b+-f"),0>(t^=tkk[1])&&(t=2147483648+(2147483647&t)),(t%=1e6).toString()+"."+(t^e)}